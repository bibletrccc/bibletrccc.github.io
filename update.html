<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="cache-control" content="max-age=0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <style>
        .bi {
            display:inline-block;
            vertical-align:-0.125em;
        }
        .bi-me-1 {
            margin-right:0.25rem;
        }
    </style>
    <title>圣经中文版Download/Update</title>
  </head>
  <body>
    <div class="container my-3" style="max-width: 30rem;">
        <h3>圣经中文版APP</h3>
        <div id="divmsg1" class="text-success my-2"></div>
        <div class="my-3">
            <button id="btnupdate" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download bi-me-1" viewBox="0 0 16 16">
                    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                    <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                  </svg>下载文件</button> <span>文件下载后，可以离线使用</span>
            <div id="divmsg2" class="text-danger my-2"></div>
        </div>
        <div class="mt-5">
            <a href="." class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left bi-me-1" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"/>
                </svg>返回圣经中文版主页</a>
        </div>
    </div>
    <script>
        var divMsg1 = document.getElementById("divmsg1");
        var divMsg2 = document.getElementById("divmsg2");
        var btnUpdate = document.getElementById("btnupdate");

        if (window.location.protocol == "https:")
            divMsg1.innerHTML = "你的网络连接是HTTPS协议(Secure)";
        else if (window.location.protocol == "http:")
            divMsg1.innerHTML = "你的网络连接是HTTP协议(Not secure)";

        btnUpdate.addEventListener("click", updateApp);

        async function updateApp() {
            btnUpdate.classList.add("disabled");
            await updateAppFiles();
            btnUpdate.classList.remove("disabled");
        }

        async function updateAppFiles() {
            divMsg2.innerHTML = "";
            if (!navigator.onLine) {
                divMsg2.innerHTML = "当前网络是断开的，无法更新！";
                return;
            }
            var testUrl = "update.html";
            if (location.protocol == "https:" || location.host == "localhost") {
                var cacheNameList = await caches.keys();
                cacheNameList = cacheNameList.filter(a => a.startsWith("bible-"));
                //1. delete the existing update.html from existing cache
                for (var i = 0; i < cacheNameList.length; i++) {
                    await caches.open(cacheNameList[i])
                        .then(cache => cache.delete(testUrl, {
                            ignoreSearch: true
                        }));
                }

                //2. check the network connection
                var isDownloadOkay = await download(testUrl).catch(err => {
                    divMsg2.innerHTML = `<div>网络出错-${err.message}<br>请稍后再试</div>`;
                    return;
                });
                if (!isDownloadOkay) {
                    divMsg2.innerHTML = "<div>无法连接到服务器<br>请稍后再试</div>";
                    return;
                }

                //3. delete the existing cache storage
                divMsg2.innerHTML = "";
                for (var i = 0; i < cacheNameList.length; i++) {
                    console.log(`delete cache - ${cacheNameList[i]}`);
                    await caches.delete(cacheNameList[i]);
                }
            } else {
                var isDownloadOkay = await download(testUrl).catch(err => {
                    divMsg2.innerHTML = `<div>网络出错-${err.message}<br>请稍后再试</div>`;
                    return;
                });
                if (!isDownloadOkay) {
                    divMsg2.innerHTML = "<div>无法连接到服务器<br>请稍后再试</div>";
                    return;
                }
            }

            await downloadAll();
        }

        async function downloadAll() {
            var urls = [".", "update.html", "01/1047.htm"];
            divMsg2.innerHTML += '<div>downloading...</div>';
            await download(".");

            for (var i = 1047; i <= 1096; i++) {
                var theFile = `01/${i}.htm`;
                await download(theFile);
            }
            for (var i = 1; i <= 103; i++) {
                var numStr = String(i).padStart(3, '0');
                var fileName = `01/zj/01_${numStr}.htm`;
                await download(fileName);
            }
            divMsg2.innerHTML = '<div>download complete!</div>';
        }
        async function download(url) {
            var result = false;
            if (!url || url.length == 0) return false;
            await fetch(url, {
                    cache: "reload"
                })
                .then(response => {
                    result = response && response.ok;
                })
                .catch(err => {
                    console.log(err);
                });
            return result;
        }		
    </script>
  </body>
</html>